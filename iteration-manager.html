<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iteration Manager (Alpine.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body
    class="bg-gray-100 p-8"
    x-data="iterationManager()"
    x-init="loadIterations()"
>
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Iteration Manager</h1>
            <a href="/admin.html" class="text-blue-500 hover:underline">&larr; Back to Admin Portal</a>
        </div>

        <p class="text-gray-600 mb-6">
            Here you can manage application iterations. Closing the active iteration archives its org chart. You can then start the "Next" iteration, which copies the structure from the last closed one, or create a completely new, blank iteration.
        </p>

        <div x-show="!activeIterationExists" class="mb-8 p-4 bg-gray-50 rounded-lg border">
            <h2 class="text-xl font-semibold mb-4" x-text="createTitle"></h2>
            <div class="space-y-4">
                <div>
                    <label for="new-iteration-name" class="block text-sm font-medium text-gray-700">New Iteration Name</label>
                    <input type="text" id="new-iteration-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="Enter name for the new iteration..." x-model="newIterationName">
                </div>
                <div>
                    <label for="question-set-select" class="block text-sm font-medium text-gray-700">Question Set</label>
                    <select id="question-set-select" class="mt-1 block w-full p-2 border rounded-md bg-white" x-model="questionSet">
                        <option value="Deep_Analysis_120.json">Deep Analysis (120 questions)</option>
                        <option value="Normal_Analysis_60.json">Normal Analysis (60 questions)</option>
                        <option value="Pulse_Check_12.json">Pulse Check (12 questions)</option>
                    </select>
                </div>
                <div>
                    <button @click="createIteration()" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">Create</button>
                </div>
            </div>
             <p class="text-xs text-gray-500 mt-2" x-text="createNote"></p>
        </div>

        <div>
            <h2 class="text-xl font-semibold mb-4">Existing Iterations</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question Set</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="iter in iterations" :key="iter.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="iter.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="iter.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="new Date(iter.start_date).toLocaleString()"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="iter.end_date ? new Date(iter.end_date).toLocaleString() : 'N/A'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="iter.question_set.replace('.json', '').replace(/_/g, ' ')"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                        :class="{ 'bg-green-100 text-green-800': !iter.end_date, 'bg-red-100 text-red-800': iter.end_date }"
                                        x-text="!iter.end_date ? 'Active' : 'Closed'">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <a href="#" x-show="!iter.end_date" @click.prevent="closeIteration(iter.id)" class="text-indigo-600 hover:text-indigo-900">Close</a>
                                    <a href="#" @click.prevent="deleteIteration(iter.id, iter.name)" class="text-red-600 hover:text-red-900 ml-4">Delete</a>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="iterations.length === 0">
                            <td colspan="7" class="text-center p-4">No iterations found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function iterationManager() {
            return {
                // --- State Properties ---
                iterations: [],
                activeIterationExists: false,
                lastClosedIteration: null,
                createTitle: '',
                createNote: '',
                newIterationName: '',
                questionSet: 'Deep_Analysis_120.json',

                // --- Methods ---
                async apiRequest(endpoint, method = 'GET', body = null) {
                    try {
                        const options = { method, headers: { 'Content-Type': 'application/json' } };
                        if (body) options.body = JSON.stringify(body);
                        const response = await fetch(endpoint, options);
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return response.status === 204 ? null : await response.json();
                    } catch (error) {
                        alert(`An API error occurred: ${error.message}`);
                        throw error;
                    }
                },

                setupCreateForm(allIterations) {
                    this.activeIterationExists = allIterations.some(i => !i.end_date);
                    if (this.activeIterationExists) return;

                    const closedIterations = allIterations.filter(i => i.end_date);
                    if (closedIterations.length === 0) {
                        this.lastClosedIteration = null;
                        this.newIterationName = 'Iteration 1';
                        this.createTitle = 'Create New (Blank) Iteration';
                        this.createNote = 'This will create the first, empty iteration.';
                        return;
                    }

                    const lastClosed = closedIterations.sort((a,b) => new Date(b.end_date) - new Date(a.end_date))[0];
                    this.lastClosedIteration = lastClosed;

                    const match = lastClosed.name.match(/\d+$/);
                    this.newIterationName = match ? lastClosed.name.replace(/\d+$/, parseInt(match[0], 10) + 1) : `Next ${lastClosed.name}`;
                    this.createTitle = 'Create Next Iteration';
                    this.createNote = `This will copy the org chart and roles from the last closed iteration: "${lastClosed.name}".`;
                },

                async loadIterations() {
                    try {
                        this.iterations = await this.apiRequest('/api/iterations');
                        this.setupCreateForm(this.iterations);
                    } catch (error) {
                        console.error("Could not load iterations.", error);
                        this.iterations = [];
                    }
                },

                async createIteration() {
                    if (!this.newIterationName.trim()) {
                        alert('Please enter a name for the iteration.');
                        return;
                    }
                    try {
                        const body = { name: this.newIterationName, question_set: this.questionSet };
                        const endpoint = this.lastClosedIteration ? '/api/iterations/next' : '/api/iterations';
                        await this.apiRequest(endpoint, 'POST', body);
                        this.newIterationName = '';
                        await this.loadIterations();
                    } catch (error) {
                        console.error("Failed to create iteration", error);
                    }
                },

                async closeIteration(id) {
                    if (confirm(`Are you sure you want to close iteration ${id}? This action cannot be undone.`)) {
                        await this.apiRequest(`/api/iterations/${id}/close`, 'PUT');
                        await this.loadIterations();
                    }
                },

                async deleteIteration(id, name) {
                    const warningMessage = `EXTREME DANGER: Are you sure you want to delete iteration "${name}" (ID: ${id})?\n\nThis will permanently delete THIS iteration AND ALL iterations that came AFTER it, along with all of their associated organizational data.\n\nThis action cannot be undone.`;
                    if (confirm(warningMessage)) {
                        await this.apiRequest(`/api/iterations/${id}`, 'DELETE');
                        await this.loadIterations();
                    }
                }
            }
        }
    </script>
</body>
</html>
