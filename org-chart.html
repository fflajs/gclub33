<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart Manager (Alpine.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .tree ul { padding-left: 20px; position: relative; }
        .tree li { list-style-type: none; margin: 10px 0; position: relative; }
        .tree li::before { content: ''; position: absolute; top: -5px; left: -20px; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; width: 20px; height: 1.1em; }
        .tree li:last-child::before { height: 1.2em; }
        .manager-icon { color: #facc15; }
        .modal { display: flex; }
    </style>
</head>
<body
    class="bg-gray-100 p-8"
    x-data="orgChartManager()"
    x-init="initialize()"
>

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-3xl font-bold">Organization Chart Manager</h1>
            <a href="/admin.html" class="text-blue-500 hover:underline">&larr; Back to Admin Portal</a>
        </div>
        <div
            class="text-center mb-6 p-2 bg-blue-50 rounded-lg border border-blue-200 text-sm"
            :class="{ 'text-blue-800': !error, 'text-red-600 font-bold': error }"
            x-text="iterationContext"
        ></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h2 class="text-xl font-semibold mb-2">Add New Top-Level Unit</h2>
                <div class="flex">
                    <input type="text" class="flex-grow p-2 border rounded-l-md" placeholder="Enter new unit name..." x-model="newUnitName" @keydown.enter="addTopLevelUnit()">
                    <button @click="addTopLevelUnit()" class="bg-blue-500 text-white p-2 rounded-r-md hover:bg-blue-600">Add Unit</button>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-2">Create New Person</h2>
                <div class="flex">
                    <input type="text" class="flex-grow p-2 border rounded-l-md" placeholder="Enter new person's full name..." x-model="newPersonName" @keydown.enter="addPerson()">
                    <button @click="addPerson()" class="bg-green-500 text-white p-2 rounded-r-md hover:bg-green-600">Create Person</button>
                </div>
            </div>
        </div>

        <div class="tree" x-html="treeHtml"></div>
    </div>

    <div x-show="isModalVisible" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center modal" style="display: none;" @click.self="hideModal()">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4" x-text="modal.title"></h3>
            
            <div class="space-y-4">
                <div>
                    <label for="modal-person-select" class="block text-sm font-medium text-gray-700">Select Person</label>
                    <select id="modal-person-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" x-model="modal.personId">
                        <option value="">Select a person...</option>
                        <template x-for="person in people" :key="person.id">
                            <option :value="person.id" x-text="person.name"></option>
                        </template>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="modal-is-manager" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" x-model="modal.isManager">
                    <label for="modal-is-manager" class="ml-2 block text-sm text-gray-900">Is Manager of this Unit?</label>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button @click="hideModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button @click="saveRole()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Add Role</button>
            </div>
        </div>
    </div>

    <script>
        function orgChartManager() {
            return {
                // --- State Properties ---
                units: [], people: [], roles: [], treeHtml: '',
                activeIterationId: null, iterationContext: 'Loading active iteration...', error: false,
                newUnitName: '', newPersonName: '',
                isModalVisible: false,
                modal: { title: '', unitId: null, personId: '', isManager: false },

                // --- Main Methods ---
                async initialize() {
                    try {
                        const activeIteration = await this.apiRequest('/api/active-iteration');
                        this.activeIterationId = activeIteration.id;
                        this.iterationContext = `Managing Organizational Chart for Active Iteration: ${activeIteration.name} (ID: ${activeIteration.id})`;
                        await this.renderTree();
                    } catch (err) {
                        this.iterationContext = `${err.message}. Please create an active iteration in the Iteration Manager.`;
                        this.error = true;
                    }
                },
                async renderTree() {
                    if (!this.activeIterationId) return;
                    try {
                        const data = await this.apiRequest(`/api/org-data/${this.activeIterationId}`);
                        this.units = data.units;
                        this.people = data.people;
                        this.roles = data.roles;
                        this.treeHtml = this.buildTreeHtml(); // Regenerate the HTML
                    } catch (err) { this.treeHtml = `<p class="text-red-500">Could not render the organization tree.</p>`; }
                },

                // --- UI Actions ---
                async addTopLevelUnit() {
                    if (this.newUnitName.trim() && this.activeIterationId) {
                        await this.apiRequest('/api/org-tree', 'POST', { name: this.newUnitName, parentId: null, iterationId: this.activeIterationId });
                        this.newUnitName = '';
                        await this.renderTree();
                    }
                },
                async addPerson() {
                    if (this.newPersonName.trim()) {
                        await this.apiRequest('/api/people', 'POST', { name: this.newPersonName });
                        this.newPersonName = '';
                        // Re-fetch all data to update the people list in the modal
                        await this.renderTree(); 
                        alert(`Person "${this.newPersonName}" created. You can now assign them to units.`);
                    }
                },
                showModal(unitId, unitName) {
                    this.modal = {
                        title: `Assign Person to "${unitName}"`,
                        unitId: unitId,
                        personId: '',
                        isManager: false
                    };
                    this.isModalVisible = true;
                },
                hideModal() { this.isModalVisible = false; },
                async saveRole() {
                    if (!this.modal.personId || !this.activeIterationId) {
                        alert('Please select a person and ensure an iteration is active.');
                        return;
                    }
                    await this.apiRequest('/api/roles', 'POST', {
                        personId: this.modal.personId,
                        orgUnitId: this.modal.unitId,
                        isManager: this.modal.isManager,
                        iterationId: this.activeIterationId
                    });
                    this.hideModal();
                    await this.renderTree();
                },
                
                // --- Tree-building Logic (kept similar to original for simplicity) ---
                buildTreeHtml(parentId = null) {
                    const children = this.units.filter(unit => unit.parent_id === parentId);
                    if (children.length === 0) return '';
                    let html = '<ul>';
                    children.forEach(unit => {
                        const unitRoles = this.roles.filter(r => r.org_unit_id === unit.id);
                        const managerRole = unitRoles.find(r => r.is_manager);
                        const coworkerRoles = unitRoles.filter(r => !r.is_manager);
                        const sortedRoles = [managerRole, ...coworkerRoles].filter(Boolean);

                        html += `
                            <li>
                                <div class="flex items-center flex-wrap">
                                    <span class="font-semibold text-lg mr-4">${unit.name}</span>
                                    <div class="inline-block space-x-2 text-sm">
                                        <a href="#" @click.prevent="addChildUnit(${unit.id})" class="text-green-600 hover:underline font-semibold">+ Add Sub-Unit</a>
                                        <a href="#" @click.prevent="showModal(${unit.id}, '${unit.name}')" class="text-purple-600 hover:underline font-semibold">+ Assign Person</a>
                                        <a href="#" @click.prevent="editUnit(${unit.id}, '${unit.name}')" class="text-blue-600 hover:underline font-semibold">Edit</a>
                                        <a href="#" @click.prevent="deleteUnit(${unit.id})" class="text-red-600 hover:underline font-semibold">Delete</a>
                                    </div>
                                </div>`;

                        sortedRoles.forEach((role, index) => {
                             const person = this.people.find(p => p.id === role.person_id);
                             if (!person) return;
                             const roleText = role.is_manager ? '(Manager)' : '(Coworker)';
                             const icon = role.is_manager ? '<span class="manager-icon">â˜…</span>' : '';
                             const bgColor = index % 2 === 0 ? 'bg-gray-50' : 'bg-transparent';
                             html += `
                                <div class="flex justify-between items-center py-1 px-2 rounded ${bgColor}">
                                    <span class="font-medium">${icon} ${person.name} ${roleText}</span>
                                    <div class="flex-shrink-0">
                                        <a href="#" @click.prevent="launchTool(${role.id}, ${person.id}, ${unit.id})" class="launch-tool-btn bg-gray-200 text-gray-800 text-xs font-bold py-1 px-2 rounded-full hover:bg-gray-300 ml-4">Launch Tool</a>
                                        <a href="#" @click.prevent="deleteRole(${role.id})" class="text-red-500 text-xs ml-2">Remove</a>
                                    </div>
                                </div>`;
                        });
                        html += this.buildTreeHtml(unit.id); // Recursive call
                        html += '</li>';
                    });
                    html += '</ul>';
                    return html;
                },

                // --- Delegated Actions from the Tree ---
                async addChildUnit(parentId) {
                    const name = prompt('Enter name for the new sub-unit:');
                    if (name && this.activeIterationId) {
                        await this.apiRequest('/api/org-tree', 'POST', { name, parentId: parentId, iterationId: this.activeIterationId });
                        await this.renderTree();
                    }
                },
                async editUnit(unitId, currentName) {
                    const newName = prompt('Enter new name for the unit:', currentName);
                    if (newName) {
                        await this.apiRequest(`/api/org-tree/${unitId}`, 'PUT', { name: newName });
                        await this.renderTree();
                    }
                },
                async deleteUnit(unitId) {
                    if (confirm('Are you sure you want to delete this unit and all its sub-units and roles?')) {
                        await this.apiRequest(`/api/org-tree/${unitId}`, 'DELETE');
                        await this.renderTree();
                    }
                },
                async deleteRole(roleId) {
                     if (confirm('Are you sure you want to remove this person from this role?')) {
                        await this.apiRequest(`/api/roles/${roleId}`, 'DELETE');
                        await this.renderTree();
                    }
                },
                launchTool(roleId, personId, unitId) {
                    const url = new URL('/cognitive-tool.html', window.location.origin);
                    url.searchParams.set('personRoleId', roleId);
                    url.searchParams.set('iterationId', this.activeIterationId);
                    url.searchParams.set('userUnitId', unitId);
                    window.location.href = url.href;
                },

                // --- Helper Methods ---
                async apiRequest(endpoint, method = 'GET', body = null) {
                    try {
                        const options = { method, headers: { 'Content-Type': 'application/json' } };
                        if (body) options.body = JSON.stringify(body);
                        const response = await fetch(endpoint, options);
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return response.status === 204 ? null : await response.json();
                    } catch (error) { alert(`An API error occurred: ${error.message}`); throw error; }
                }
            }
        }
    </script>
</body>
</html>
