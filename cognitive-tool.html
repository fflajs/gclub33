<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitive Space Visualization (Alpine.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #111827; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 2rem; background-color: #ffffff; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .slider-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .chart-container { width: 100%; height: 300px; margin-bottom: 2rem; display: flex; justify-content: center; }
        .voxel-container { width: 100%; height: 600px; border-radius: 1rem; overflow: hidden; background-color: #e5e7eb; display: flex; justify-content: center; align-items: center; }
        .voxel-canvas { width: 100%; height: 100%; display: block; }
    </style>
</head>
<body x-data="cognitiveTool()" x-init="initialize()">
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="text-3xl font-bold">Cognition Space Visualizer</h1>
            <p class="text-blue-600 font-semibold mt-1" x-text="iterationDisplay"></p>
        </div>
        <div class="text-center mb-6 p-3 bg-gray-100 rounded-lg border text-sm" x-html="userContextDisplay"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label for="target-textarea" class="text-lg font-semibold text-gray-800">Target</label>
                <textarea id="target-textarea" rows="4" class="w-full mt-2 p-2 border rounded-lg resize-y font-mono text-sm bg-white" placeholder="Overall target set by root manager..." x-model="targetText" :readonly="!canEditTarget"></textarea>
                <button @click="saveTarget()" class="mt-2 w-full p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400" :disabled="!canEditTarget">Save Target</button>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label for="description-textarea" class="text-lg font-semibold text-gray-800">Description</label>
                <textarea id="description-textarea" rows="4" class="w-full mt-2 p-2 border rounded-lg resize-y font-mono text-sm bg-white" placeholder="Your personal description for this role..." x-model="descriptionText"></textarea>
                <button @click="saveDescription()" class="mt-2 w-full p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Description</button>
            </div>
        </div>

        <div x-show="stats.isManager" class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-8">
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Organization Statistics (Active Iteration)</h2>
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th scope="col" class="px-6 py-3">Metric</th><th scope="col" class="px-6 py-3 text-center">Count</th><th scope="col" class="px-6 py-3 text-center">Percentage</th></tr></thead>
                <tbody>
                    <template x-for="stat in stats.rows" :key="stat.label">
                        <tr class="bg-white border-b"><td class="px-6 py-2 font-medium text-gray-900" x-text="stat.label"></td><td class="px-6 py-2 text-center" x-text="stat.value"></td><td class="px-6 py-2 text-center" x-text="stat.percent"></td></tr>
                    </template>
                </tbody>
            </table>
        </div>

        <p class="text-gray-600 text-center mb-8" x-text="`Enter ${questionStrings.length} values to compute the mean, mode, and visualize the data.`"></p>

        <div class="p-6 mb-8 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-center">Survey Questions</h2>
            <div class="slider-container">
                <template x-for="(question, index) in questionStrings" :key="index">
                    <div class="slider-item">
                        <label class="block text-sm font-medium text-gray-700">
                            <span x-text="question"></span> - Value: <span x-text="surveyValues[index]"></span>
                        </label>
                        <div class="relative pt-1">
                            <input type="range" class="w-full" min="1" max="8" x-model.number="surveyValues[index]" @input="updateAllVisuals()">
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold">Computed JSON Data</h2>
            <textarea class="w-full h-48 mt-4 p-4 border rounded-lg resize-none font-mono text-sm bg-gray-100" readonly x-text="jsonOutput"></textarea>
            <div class="flex justify-between mt-4 space-x-4">
                <button @click="resetSurvey()" class="flex-1 p-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500">Reset</button>
                <button @click="saveSurvey()" class="flex-1 p-3 bg-green-500 text-white rounded-lg hover:bg-green-600">Save to Server</button>
            </div>
            <p class="text-xs mt-2 block text-center" :class="message.isError ? 'text-red-600' : 'text-green-600'" x-text="message.text"></p>
        </div>
        
        <div class="p-6 mt-8 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-center">Gaussian Distributions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="chart-container"><canvas x-ref="knowledgeChart"></canvas></div>
                <div class="chart-container"><canvas x-ref="familiarityChart"></canvas></div>
                <div class="chart-container"><canvas x-ref="cognitiveLoadChart"></canvas></div>
            </div>
        </div>
        
        <div class="p-6 mb-8 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-center">3D Voxel Scene</h2>
            <div class="voxel-container"><canvas x-ref="mainVoxelCanvas"></canvas></div>
        </div>

        <div class="p-6 mt-8 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-center">Analysis & Coaching</h2>
            <div class="text-center">
                <p class="text-lg font-medium text-gray-800" x-text="analysis.desc"></p>
                <p class="mt-2 text-md text-gray-600" x-text="analysis.tip"></p>
            </div>
        </div>
        
        <div x-show="stats.isManager" class="p-6 mt-8 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-center">Calculation</h2>
            <div class="flex flex-col items-center">
                <button @click="calculateAverage()" class="p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Calculate Unit Average</button>
            </div>
            <div x-show="avg.data" class="mt-8">
                <h2 class="text-2xl font-semibold mb-4 text-center">Average Gaussian Distributions</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="chart-container"><canvas x-ref="avgKnowledgeChart"></canvas></div>
                    <div class="chart-container"><canvas x-ref="avgFamiliarityChart"></canvas></div>
                    <div class="chart-container"><canvas x-ref="avgCognitiveLoadChart"></canvas></div>
                </div>
                <h2 class="text-2xl font-semibold mt-8 mb-4 text-center">Average 3D Voxel Scene</h2>
                <div class="voxel-container"><canvas x-ref="avgVoxelCanvas"></canvas></div>
                <div class="p-6 mt-8 bg-gray-50 rounded-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Analysis & Coaching for Average Data</h2>
                    <div class="text-center">
                        <p class="text-lg font-medium text-gray-800" x-text="avg.analysis.desc"></p>
                        <p class="mt-2 text-md text-gray-600" x-text="avg.analysis.tip"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('cognitiveTool', function () {
        return {
            // --- State Properties ---
            params: new URLSearchParams(window.location.search),
            personRoleId: null, iterationId: null, userUnitId: null, personId: null,
            canEditTarget: false,
            iterationDisplay: 'Loading active iteration...',
            userContextDisplay: '',
            targetText: '', descriptionText: '',
            questionStrings: [], surveyValues: [], voxelMap: new Map(),
            jsonOutput: '',
            analysis: { desc: 'Adjust sliders to see analysis.', tip: '' },
            stats: { isManager: false, rows: [] },
            avg: { data: null, sourceFiles: [], analysis: { desc: '', tip: '' } },
            message: { text: '', isError: false },
            charts: { main: {}, avg: {} },
            scenes: { main: null, avg: null },

            // --- Initialization ---
            async initialize() {
                this.personRoleId = this.params.get('personRoleId');
                this.iterationId = this.params.get('iterationId');
                this.userUnitId = this.params.get('userUnitId');

                if (!this.personRoleId || !this.iterationId) {
                    this.userContextDisplay = `<span class="text-red-500 font-bold">Invalid Access. Please login.</span>`;
                    return;
                }
                
                // Set up the watcher to handle the average visuals automatically
                this.$watch('avg.data', (newData) => {
                    if (newData) { // If avg.data receives any data
                        this.$nextTick(() => { // Wait for the DOM to show the canvases
                            this.renderAverageVisuals();
                        });
                    }
                });
                
                await Promise.all([
                    this.loadIterationContext(),
                    this.handleUserContext(),
                    this.loadAppData(),
                    this.loadVoxelData()
                ]);
                await this.loadQuestions();
                
                this.$nextTick(() => {
                    this.initMainVisuals();
                    this.loadInitialSurveys();
                });
            },

            // --- Visual Initializers ---
            initMainVisuals() {
                this.scenes.main = this.initVoxelScene(this.$refs.mainVoxelCanvas);
            },

            // --- Data Loading & Actions ---
            async loadInitialSurveys() {
                try {
                    const data = await this.apiRequest(`/api/initial-load/${this.personRoleId}`);
                    if (data.individualData) {
                        this.surveyValues = data.individualData.survey_results;
                        this.showMessage('Personal survey data loaded.');
                    }
                    if (data.calculatedData) {
                        this.avg.data = data.calculatedData; // This will trigger the $watch
                    }
                } catch(e) { console.log('No initial survey data found.'); }
                
                this.updateAllVisuals(); 
            },

            async calculateAverage() {
                this.showMessage('Calculating unit average...');
                const result = await this.apiRequest(`/api/calculate`, 'POST', { personRoleId: this.personRoleId, orgUnitId: this.userUnitId, iterationId: this.iterationId });
                this.avg.sourceFiles = result.sourceFiles;
                this.avg.data = result.calculationResult.data; // This will trigger the $watch
                this.showMessage(result.message);
            },
            
            // --- Visual Updates ---
            updateAllVisuals() {
                const data = this.calculateData(this.surveyValues);
                if (!data) return;
                this.jsonOutput = JSON.stringify(data, null, 2);
                this.renderMainCharts(data.analysis.graphs);
                this.updateVoxelScene(this.scenes.main, data.analysis.voxel, []);
                this.updateAnalysisText(this.analysis, data.analysis.voxel.roundedMean);
            },

            renderMainCharts(graphData) {
                if(!graphData) return;
                // Destroy and re-create main charts
                if (this.charts.main.knowledge) this.charts.main.knowledge.destroy();
                if (this.charts.main.familiarity) this.charts.main.familiarity.destroy();
                if (this.charts.main.cognitive) this.charts.main.cognitive.destroy();

                this.charts.main.knowledge = this.createChart(this.$refs.knowledgeChart, 'Knowledge Density', graphData.knowledge_density.distribution_data, '75, 192, 192');
                this.charts.main.familiarity = this.createChart(this.$refs.familiarityChart, 'Familiarity', graphData.familiarity.distribution_data, '54, 162, 235');
                this.charts.main.cognitive = this.createChart(this.$refs.cognitiveLoadChart, 'Cognitive Load', graphData.cognitive_load.distribution_data, '255, 159, 64');
            },

            renderAverageVisuals() {
                if (!this.avg.data) return;

                // Destroy and re-create average charts
                if (this.charts.avg.knowledge) this.charts.avg.knowledge.destroy();
                if (this.charts.avg.familiarity) this.charts.avg.familiarity.destroy();
                if (this.charts.avg.cognitive) this.charts.avg.cognitive.destroy();

                this.charts.avg.knowledge = this.createChart(this.$refs.avgKnowledgeChart, 'Avg. Knowledge Density', this.avg.data.analysis.graphs.knowledge_density.distribution_data, '75, 192, 192');
                this.charts.avg.familiarity = this.createChart(this.$refs.avgFamiliarityChart, 'Avg. Familiarity', this.avg.data.analysis.graphs.familiarity.distribution_data, '54, 162, 235');
                this.charts.avg.cognitive = this.createChart(this.$refs.avgCognitiveLoadChart, 'Avg. Cognitive Load', this.avg.data.analysis.graphs.cognitive_load.distribution_data, '255, 159, 64');
                
                // Initialize the voxel scene if it doesn't exist
                if (!this.scenes.avg) {
                    this.scenes.avg = this.initVoxelScene(this.$refs.avgVoxelCanvas);
                }
                this.updateVoxelScene(this.scenes.avg, this.avg.data.analysis.voxel, this.avg.sourceFiles);
                this.updateAnalysisText(this.avg.analysis, this.avg.data.analysis.voxel.roundedMean);
            },
            
            // --- Unchanged Helper Functions (with one key change in createChart) ---
            createChart(canvas, title, data, color) {
                if (!canvas) return null;
                const chartLabels = Array.from({ length: 71 }, (_, i) => (1 + i * 0.1).toFixed(1));
                const dataset = {
                    label: title, data,
                    borderColor: `rgb(${color})`, backgroundColor: `rgba(${color}, 0.2)`,
                    borderWidth: 2, fill: true, tension: 0.4
                };
                return new Chart(canvas, {
                    type: 'line',
                    data: { labels: chartLabels, datasets: [dataset] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: title } } }
                });
            },
            async loadIterationContext() { try { const d = await this.apiRequest('/api/active-iteration'); const q = d.question_set.replace('.json', '').replace(/_/g, ' '); this.iterationDisplay = `Active Iteration: ${d.name} (ID: ${this.iterationId}) | Question Set: ${q}`; } catch (e) { this.iterationDisplay = `Error: ${e.message}`; } },
            async handleUserContext() { try { const d = await this.apiRequest(`/api/person-context/${this.personRoleId}`); this.personId = d.personId; this.descriptionText = d.description || ''; this.stats.isManager = d.is_manager; this.userContextDisplay = `<span class="font-semibold">User:</span> <span class="text-blue-600">${d.name}</span> | <span class="font-semibold">Role:</span> <span class="text-blue-600">${d.is_manager ? 'Manager' : 'Coworker'}</span> | <span class="font-semibold">Unit:</span> <span class="text-blue-600">${d.orgUnitName}</span>`; this.canEditTarget = d.isRootManager && (parseInt(this.iterationId, 10) === d.firstIterationId); if (this.stats.isManager) this.loadStats(); } catch(e){ this.userContextDisplay = `<span class="text-red-500 font-bold">Could not load user context.</span>`; } },
            async loadAppData() { try { const d = await this.apiRequest(`/api/app-data/target`); this.targetText = d.value || ''; } catch(e) { this.showMessage('Could not load Target data.', true); } },
            async loadVoxelData() { const r = await fetch(`/api/voxel-data`); const c = await r.text(); c.trim().split('\n').slice(1).forEach(l => { const p = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if (p.length > 12) { this.voxelMap.set(p[0].replace(/"/g, '').replace(/\\/g, ''), { short_desc: p[11].replace(/"/g, ''), coach_tip: p[12].replace(/"/g, '').replace(/;/g, ', ') }); } }); },
            async loadQuestions() { this.questionStrings = await this.apiRequest(`/api/questions/${this.iterationId}`); this.surveyValues = Array(this.questionStrings.length).fill(4); },
            async loadStats() { const s = await this.apiRequest(`/api/organization-stats/${this.personRoleId}`); const f = (n, d) => d === 0 ? 'N/A' : `${((n / d) * 100).toFixed(1)}%`; this.stats.rows = [{ label: 'Is the Objective entered?', value: s.targetEntered > 0 ? 'Yes' : 'No', percent: s.targetEntered > 0 ? '100%' : '0%' }, { label: 'Total roles:', value: s.totalRoles, percent: '100%' }, { label: 'Roles with a "Description":', value: s.descriptionsEntered, percent: f(s.descriptionsEntered, s.totalRoles) }, { label: 'Roles with "cognitive_data":', value: s.cognitiveDataEntered, percent: f(s.cognitiveDataEntered, s.totalRoles) }, { label: 'Total units:', value: s.totalUnits, percent: '100%' }, { label: 'Units with a calculated average:', value: s.calculatedUnits, percent: f(s.calculatedUnits, s.totalUnits) }]; },
            calculateData(v) { const t = v.length; if (t === 0) return null; const q = t / 3; const g = (a) => a.length > 0 ? a.reduce((c, d) => c + d, 0) / a.length : 0; const k = v.slice(0, q); const f = v.slice(q, q * 2); const c = v.slice(q * 2); const mX = g(k), mY = g(f), mZ = g(c); return { timestamp: new Date().toISOString(), survey_results: v, analysis: { voxel: { mean: { x: +mX.toFixed(2), y: +mY.toFixed(2), z: +mZ.toFixed(2) }, roundedMean: { x: Math.round(Math.min(Math.max(mX, 1), 8)), y: Math.round(Math.min(Math.max(mY, 1), 8)), z: Math.round(Math.min(Math.max(mZ, 1), 8)) } }, graphs: { knowledge_density: { mean: +mX.toFixed(2), distribution_data: this.getGaussianData(mX) }, familiarity: { mean: +mY.toFixed(2), distribution_data: this.getGaussianData(mY) }, cognitive_load: { mean: +mZ.toFixed(2), distribution_data: this.getGaussianData(mZ) } } } }; },
            updateAnalysisText(t, r) { if (!r) return; const k = `[${r.x},${r.y},${r.z}]`; const d = this.voxelMap.get(k); t.desc = d ? d.short_desc : 'No specific analysis for this combination.'; t.tip = d ? `Coaching Tip: ${d.coach_tip}` : ''; },
            resetSurvey() { this.surveyValues = Array(this.questionStrings.length).fill(4); this.updateAllVisuals(); this.showMessage('Sliders reset!'); },
            async saveTarget() { await this.apiRequest(`/api/app-data/target`, 'PUT', { value: this.targetText, personId: this.personId }); this.showMessage('Target saved successfully.'); },
            async saveDescription() { await this.apiRequest(`/api/role-description`, 'PUT', { description: this.descriptionText, personRoleId: this.personRoleId }); this.showMessage('Description saved successfully.'); },
            async saveSurvey() { const d = { ...JSON.parse(this.jsonOutput), personRoleId: this.personRoleId, orgUnitId: this.userUnitId, iterationId: this.iterationId }; const r = await this.apiRequest(`/api/saved-files`, 'POST', d); this.showMessage(`File saved as ${r.filename}`); },
            initVoxelScene(c) { if (!c) return null; const s = new THREE.Scene(); s.background = new THREE.Color(0xf3f4f6); const a = new THREE.PerspectiveCamera(50, c.clientWidth / c.clientHeight, 0.1, 1000); a.position.set(1.2, 1.2, 1.2); const r = new THREE.WebGLRenderer({ antialias: true, canvas: c }); r.setSize(c.clientWidth, c.clientHeight); s.add(new THREE.AmbientLight(0xffffff, 0.6)); const d = new THREE.DirectionalLight(0xffffff, 0.8); d.position.set(5, 10, 7.5); s.add(d); const o = new THREE.OrbitControls(a, r.domElement); o.enableDamping = true; const n = () => { requestAnimationFrame(n); o.update(); r.render(s, a); }; n(); return { scene: s, camera: a, renderer: r, grid: this.createVoxelGrid(s) }; },
            createVoxelGrid(s) { const g = []; const G = new THREE.BoxGeometry(1/8, 1/8, 1/8); const m = new THREE.MeshBasicMaterial({ color: 0xaaaaaa, wireframe: true, opacity: 0.2, transparent: true }); for (let z = 1; z <= 8; z++) for (let y = 1; y <= 8; y++) for (let x = 1; x <= 8; x++) { const v = new THREE.Mesh(G, m); v.position.set((x - 0.5) / 8 - 0.5, (y - 0.5) / 8 - 0.5, (z - 0.5) / 8 - 0.5); s.add(v); g.push(v); } return g; },
            updateVoxelScene(s, v, f) { if (!s || !v) return; const R = new THREE.MeshBasicMaterial({ color: 0xef4444, opacity: 0.7, transparent: true }); const Y = new THREE.MeshBasicMaterial({ color: 0xfacc15, opacity: 0.6, transparent: true }); const G = new THREE.MeshBasicMaterial({ color: 0xaaaaaa, wireframe: true, opacity: 0.2, transparent: true }); s.grid.forEach(o => o.material = G); (f || []).forEach(l => { const { x, y, z } = l.data.analysis.voxel.roundedMean; const i = (x - 1) + (y - 1) * 8 + (z - 1) * 64; if (s.grid[i]) s.grid[i].material = Y; }); const { x, y, z } = v.roundedMean; const i = (x - 1) + (y - 1) * 8 + (z - 1) * 64; if (s.grid[i]) s.grid[i].material = R; const c = s.renderer.domElement; if (c.parentElement.clientWidth > 0) { s.renderer.setSize(c.parentElement.clientWidth, c.parentElement.clientHeight); s.camera.aspect = c.parentElement.clientWidth / c.parentElement.clientHeight; s.camera.updateProjectionMatrix(); } },
            showMessage(t, i = false) { this.message = { text: t, isError: i }; setTimeout(() => this.message.text = '', 4000); },
            getGaussianData: (m, s = 1) => Array.from({length: 71}, (_, i) => { const x = 1 + i*0.1; return Math.exp(-0.5 * Math.pow((x - m) / s, 2)) / (s * Math.sqrt(2 * Math.PI)); }),
            async apiRequest(e, m = 'GET', b = null) { try { const o = { method: m, headers: { 'Content-Type': 'application/json' } }; if (b) o.body = JSON.stringify(b); const r = await fetch(e, o); if (!r.ok) { const d = await r.json(); throw new Error(d.message); } return r.status === 204 ? null : await r.json(); } catch (r) { this.showMessage(r.message, true); throw r; } },
        }
    });
});
</script>
</body>
</html>
