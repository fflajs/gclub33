<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Table Viewer (Alpine.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body 
    class="bg-gray-100 p-8"
    x-data="tableViewer()"
    x-init="fetchData()"
>
    <div class="max-w-7xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Database Table Viewer</h1>
            <a href="/admin.html" class="text-blue-500 hover:underline">&larr; Back to Admin Portal</a>
        </div>

        <div x-show="isLoading" class="text-center p-8">
            <p class="text-gray-600">Loading all table data, please wait...</p>
        </div>

        <div x-show="error" class="text-center p-8 bg-red-50 rounded-lg">
            <p class="text-red-600 font-semibold" x-text="error"></p>
        </div>

        <div x-show="!isLoading && !error">
            <div class="mb-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <template x-for="tableName in tableNames" :key="tableName">
                        <button 
                            @click="activeTable = tableName"
                            :class="activeTable === tableName ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            x-text="tableName.replace(/_/g, ' ')"
                        ></button>
                    </template>
                </nav>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <template x-for="header in getTableHeaders()" :key="header">
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="header.replace(/_/g, ' ')"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="(row, index) in getTableData()" :key="index">
                            <tr>
                                <template x-for="header in getTableHeaders()" :key="header">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                        <pre class="whitespace-pre-wrap break-all" x-text="formatCell(row[header])"></pre>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
                 <div x-show="getTableData().length === 0" class="text-center p-4 text-gray-500">
                    This table has no data.
                </div>
            </div>
        </div>
    </div>

    <script>
        function tableViewer() {
            return {
                // --- State Properties ---
                allData: {},
                tableNames: [],
                activeTable: '',
                isLoading: true,
                error: '',

                // --- Initialization ---
                async fetchData() {
                    try {
                        const response = await fetch('/api/all-tables-data');
                        if (!response.ok) {
                            throw new Error('Failed to fetch data from the server.');
                        }
                        this.allData = await response.json();
                        this.tableNames = Object.keys(this.allData);
                        if (this.tableNames.length > 0) {
                            this.activeTable = this.tableNames[0];
                        }
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.isLoading = false;
                    }
                },

                // --- Computed-like Getters ---
                getTableHeaders() {
                    if (!this.activeTable || !this.allData[this.activeTable] || this.allData[this.activeTable].length === 0) {
                        return [];
                    }
                    return Object.keys(this.allData[this.activeTable][0]);
                },
                getTableData() {
                    return this.allData[this.activeTable] || [];
                },

                // --- Helper ---
                formatCell(value) {
                    if (value === null) return 'NULL';
                    if (typeof value === 'object') {
                        try {
                            return JSON.stringify(value, null, 2);
                        } catch (e) {
                            return '[Circular Object]';
                        }
                    }
                    return value;
                }
            }
        }
    </script>
</body>
</html>
